-- #310
DELETE pbl_consulta_hist_list;
INSERT INTO pbl_consulta_hist_list ( id, peticioId, solicitudId, data, departament, recobriment, multiple, usuariCodi, usuariNom, funcionariNom, funcionariNif, titularNom, titularDoctip, titularDocnum, procedimentId, procedimentCodi, procedimentNom, serveiCodi, serveiNom, estat, error, justificantEstat, entitatId, entitatCodi, pareId) SELECT c.ID, c.PETICION_ID, c.SOLICITUD_ID, c.CREATEDDATE, c.DEPARTAMENT, c.RECOBRIMENT, c.MULTIPLE, c.CREATEDBY_CODI, u.NOM, c.FUNCIONARI_NOM, c.FUNCIONARI_DOCNUM, COALESCE(c.TITULAR_NOMCOMPLET, NULLIF(CONCAT(COALESCE(CONCAT(c.TITULAR_NOM, ' '), ''), CONCAT(COALESCE(CONCAT(c.TITULAR_LLING1, ' '), ''), COALESCE(c.TITULAR_LLING2, ''))), '')), c.TITULAR_DOCTIP, c.TITULAR_DOCNUM, p.ID, p.CODI, p.NOM, c.SERVEI_CODI, s.DESCRIPCION, CASE WHEN c.ESTAT = '0' THEN 'Pendent' WHEN c.ESTAT = '1' THEN 'Processant' WHEN c.ESTAT = '2' THEN 'Tramitada' WHEN c.ESTAT = '3' THEN 'Error' WHEN c.ESTAT = '4' THEN 'Encua' END, c.ERROR, CASE WHEN c.JUSTIFICANT_ESTAT = '0' THEN 'PENDENT' WHEN c.JUSTIFICANT_ESTAT = '1' THEN 'OK' WHEN c.JUSTIFICANT_ESTAT = '2' THEN 'ERROR' WHEN c.JUSTIFICANT_ESTAT = '3' THEN 'NO_DISPONIBLE' WHEN c.JUSTIFICANT_ESTAT = '4' THEN 'OK_NO_CUSTODIA' END, e.ID, e.CODI, c.PARE_ID FROM pbl_consulta_hist c LEFT OUTER JOIN PBL_ENTITAT e on c.ENTITAT_ID = e.ID LEFT OUTER JOIN PBL_PROCEDIMENT p on c.PROCEDIMENT_ID = p.ID LEFT OUTER JOIN CORE_SERVICIO s on c.SERVEI_CODI = s.CODCERTIFICADO LEFT OUTER JOIN PBL_USUARI u on c.CREATEDBY_CODI = u.CODI;
